#!/bin/bash
# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Android –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ enx566cf3eaaf4b

INTERFACE="enx566cf3eaaf4b"
echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Android –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ $INTERFACE"
echo "=============================================="

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
echo "1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:"
if ip link show $INTERFACE &>/dev/null; then
    echo "‚úÖ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å $INTERFACE –Ω–∞–π–¥–µ–Ω"
    ip addr show $INTERFACE | grep "inet "
else
    echo "‚ùå –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å $INTERFACE –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi
echo ""

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
echo "2. –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:"
STATE=$(ip link show $INTERFACE | grep -o "state [A-Z]*" | cut -d' ' -f2)
echo "–°–æ—Å—Ç–æ—è–Ω–∏–µ: $STATE"

if [ "$STATE" != "UP" ]; then
    echo "‚ö†Ô∏è –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ UP, –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–Ω—è—Ç—å..."
    sudo ip link set $INTERFACE up
    sleep 2
fi
echo ""

# 3. –ü—Ä—è–º–æ–π —Ç–µ—Å—Ç —á–µ—Ä–µ–∑ curl
echo "3. –¢–µ—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:"
echo "–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è: curl --interface $INTERFACE http://httpbin.org/ip"

RESULT=$(curl --interface $INTERFACE -s --connect-timeout 10 http://httpbin.org/ip 2>&1)
if [ $? -eq 0 ]; then
    echo "‚úÖ –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω:"
    echo "$RESULT" | jq . 2>/dev/null || echo "$RESULT"

    # –ò–∑–≤–ª–µ–∫–∞–µ–º IP
    EXTERNAL_IP=$(echo "$RESULT" | jq -r '.origin' 2>/dev/null || echo "unknown")
    echo "üåê –í–Ω–µ—à–Ω–∏–π IP —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: $EXTERNAL_IP"
else
    echo "‚ùå –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –Ω–µ—É–¥–∞—á–µ–Ω:"
    echo "$RESULT"
fi
echo ""

# 4. –¢–µ—Å—Ç —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏
echo "4. –¢–µ—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏:"
echo "–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è: curl -x http://192.168.1.50:8080 http://httpbin.org/ip"

PROXY_RESULT=$(curl -x http://192.168.1.50:8080 -s --connect-timeout 10 http://httpbin.org/ip 2>&1)
if [ $? -eq 0 ]; then
    echo "‚úÖ –ü—Ä–æ–∫—Å–∏ –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω:"
    echo "$PROXY_RESULT" | jq . 2>/dev/null || echo "$PROXY_RESULT"

    # –ò–∑–≤–ª–µ–∫–∞–µ–º IP
    PROXY_IP=$(echo "$PROXY_RESULT" | jq -r '.origin' 2>/dev/null || echo "unknown")
    echo "üåê –í–Ω–µ—à–Ω–∏–π IP —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏: $PROXY_IP"

    # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º IP
    if [ "$EXTERNAL_IP" = "$PROXY_IP" ] && [ "$EXTERNAL_IP" != "unknown" ]; then
        echo "üéâ –£–°–ü–ï–•! –ü—Ä–æ–∫—Å–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Android –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"
    elif [ "$PROXY_IP" = "178.178.91.162" ]; then
        echo "‚ùå –ü–†–û–ë–õ–ï–ú–ê! –ü—Ä–æ–∫—Å–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–µ—Ä–≤–µ—Ä–∞"
        echo "   –ù—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–∞"
    else
        echo "‚ö†Ô∏è IP –∞–¥—Ä–µ—Å–∞ —Ä–∞–∑–ª–∏—á–∞—é—Ç—Å—è:"
        echo "   –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å: $EXTERNAL_IP"
        echo "   –ü—Ä–æ–∫—Å–∏: $PROXY_IP"
    fi
else
    echo "‚ùå –ü—Ä–æ–∫—Å–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ—É–¥–∞—á–µ–Ω:"
    echo "$PROXY_RESULT"
fi
echo ""

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–∫—Å–∏
echo "5. –°—Ç–∞—Ç—É—Å –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–∞:"
PROXY_STATUS=$(curl -s http://192.168.1.50:8080/status 2>&1)
if [ $? -eq 0 ]; then
    echo "$PROXY_STATUS" | jq '.device_interfaces[] | select(.interface == "'$INTERFACE'")' 2>/dev/null || echo "–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å—Ç–∞—Ç—É—Å–µ"
else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–∫—Å–∏"
fi
echo ""

# 6. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
echo "6. –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:"
ip route show dev $INTERFACE
echo ""

echo "=============================================="
echo "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"

# –í—ã–≤–æ–¥–∏–º –∑–∞–∫–ª—é—á–µ–Ω–∏–µ
if [ "$EXTERNAL_IP" = "$PROXY_IP" ] && [ "$EXTERNAL_IP" != "unknown" ]; then
    echo "üéâ –°–¢–ê–¢–£–°: –í–°–ï –†–ê–ë–û–¢–ê–ï–¢ –ü–†–ê–í–ò–õ–¨–ù–û"
    echo "   –ü—Ä–æ–∫—Å–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Android –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"
else
    echo "‚ùå –°–¢–ê–¢–£–°: –¢–†–ï–ë–£–ï–¢–°–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï"
    echo "   –ü—Ä–æ–∫—Å–∏ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Android –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"
    echo ""
    echo "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "1. –ö–æ–¥ –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω"
    echo "2. –ü—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
    echo "3. –û—à–∏–±–∫–∞ –≤ –ª–æ–≥–∏–∫–µ –≤—ã–±–æ—Ä–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"
    echo ""
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏"
fi


# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ backend –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

echo "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–æ–º"
echo "=========================================="

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—É—â–µ–Ω –ª–∏ backend
echo "1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ backend:"
ps aux | grep -E "(python.*app\.main|uvicorn|fastapi)" | grep -v grep
echo ""

# 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç—ã
echo "2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤:"
netstat -tlnp | grep -E ":(8000|8080)"
echo ""

# 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API
echo "3. –ü—Ä–æ–≤–µ—Ä–∫–∞ API backend:"
curl -s http://192.168.1.50:8000/health | head -5
echo ""

# 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
echo "4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤:"
curl -s http://192.168.1.50:8000/admin/modems | jq '.[] | {id, type, interface, status}' 2>/dev/null || echo "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤"
echo ""

# 5. –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä–æ–∫—Å–∏ —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
echo "5. –¢–µ—Å—Ç –ø—Ä–æ–∫—Å–∏ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:"
curl -x http://192.168.1.50:8080 -H "X-Proxy-Device-ID: android_AH3SCP4B11207250" -v http://httpbin.org/ip 2>&1 | head -20
echo ""

# 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–∞
echo "6. –°—Ç–∞—Ç—É—Å –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–∞:"
curl -s http://192.168.1.50:8080/status | jq . 2>/dev/null || curl -s http://192.168.1.50:8080/status
echo ""

# 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä–Ω–µ–≤–æ–π –ø—É—Ç—å –ø—Ä–æ–∫—Å–∏
echo "7. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–∫—Å–∏:"
curl -s http://192.168.1.50:8080/ | jq . 2>/dev/null || curl -s http://192.168.1.50:8080/
echo ""

# 8. –ü–æ–∏—Å–∫ –ª–æ–≥–æ–≤
echo "8. –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤:"
find /var/www/p-service -name "*.log" -o -name "backend.log" 2>/dev/null
find /tmp -name "*proxy*" -o -name "*backend*" 2>/dev/null | head -5
find . -name "*.log" 2>/dev/null

echo ""
echo "=========================================="
echo "–î–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ backend –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏:"
echo "cd /var/www/p-service/backend"
echo "python -m app.main"
echo "–ò –æ—Ç—Å–ª–µ–¥–∏—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞"


