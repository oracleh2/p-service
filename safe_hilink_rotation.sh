#!/bin/bash

# –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –†–û–¢–ê–¶–ò–Ø IP –ß–ï–†–ï–ó HILINK API
# –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç AT –∫–æ–º–∞–Ω–¥—ã –∏ –Ω–µ –ª–æ–º–∞–µ—Ç —Å–µ—Ç–µ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

MODEM_IP="192.168.108.1"
INTERFACE="enx0c5b8f279a64"

echo "üîí –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –†–û–¢–ê–¶–ò–Ø IP –ß–ï–†–ï–ó HILINK API"
echo "========================================"
echo "‚ö†Ô∏è  –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º AT –∫–æ–º–∞–Ω–¥—ã - —Ç–æ–ª—å–∫–æ –≤–µ–±-API!"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è HiLink API –∑–∞–ø—Ä–æ—Å–æ–≤
hilink_api_request() {
    local url="$1"
    local method="$2"
    local data="$3"

    if [ "$method" = "GET" ]; then
        curl -s -m 10 "http://$MODEM_IP$url" 2>/dev/null
    else
        curl -s -m 10 -X "$method" -d "$data" "http://$MODEM_IP$url" 2>/dev/null
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ IP
get_external_ip() {
    curl --interface "$INTERFACE" -s --connect-timeout 10 https://httpbin.org/ip 2>/dev/null | grep -o '"[0-9.]*"' | tr -d '"'
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ —Å–µ—Å—Å–∏–∏
get_session_token() {
    local response=$(hilink_api_request "/api/webserver/SesTokInfo" "GET")

    if [ -n "$response" ]; then
        local session_id=$(echo "$response" | grep -o '<SesInfo>[^<]*</SesInfo>' | sed 's/<[^>]*>//g')
        local token=$(echo "$response" | grep -o '<TokInfo>[^<]*</TokInfo>' | sed 's/<[^>]*>//g')

        if [ -n "$session_id" ] && [ -n "$token" ]; then
            echo "$session_id|$token"
            return 0
        fi
    fi

    return 1
}

echo ""
echo "1. –°–Ω–∞—á–∞–ª–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–¥–µ–º —Ñ–∏–∑–∏—á–µ—Å–∫–∏"
echo "=========================================="
echo "üîå –ü–ï–†–ï–î –ü–†–û–î–û–õ–ñ–ï–ù–ò–ï–ú:"
echo "1. –í—ã–¥–µ—Ä–Ω–∏ USB –º–æ–¥–µ–º –∏–∑ –ø–æ—Ä—Ç–∞"
echo "2. –ü–æ–¥–æ–∂–¥–∏ 5 —Å–µ–∫—É–Ω–¥"
echo "3. –í—Å—Ç–∞–≤—å –º–æ–¥–µ–º –æ–±—Ä–∞—Ç–Ω–æ"
echo "4. –ü–æ–¥–æ–∂–¥–∏ 30 —Å–µ–∫—É–Ω–¥ –ø–æ–∫–∞ –º–æ–¥–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è"
echo ""

read -p "–ú–æ–¥–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω –∏ –≥–æ—Ç–æ–≤? (y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "‚ùå –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏ –º–æ–¥–µ–º –∏ –∑–∞–ø—É—Å—Ç–∏ —Å–∫—Ä–∏–ø—Ç –∑–∞–Ω–æ–≤–æ"
    exit 1
fi

echo ""
echo "2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–º–∞"
echo "=============================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞..."
if ! curl -s -m 5 "http://$MODEM_IP" >/dev/null 2>&1; then
    echo "‚ùå –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–æ–¥–µ–º–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    echo "üîß –ü—Ä–æ–≤–µ—Ä—å:"
    echo "   - –ú–æ–¥–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω"
    echo "   - –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å $INTERFACE –∞–∫—Ç–∏–≤–µ–Ω"
    echo "   - IP –∞–¥—Ä–µ—Å 192.168.108.1 –¥–æ—Å—Ç—É–ø–µ–Ω"
    exit 1
fi

echo "‚úÖ –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–æ—Å—Ç—É–ø–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞..."
CURRENT_IP=$(get_external_ip)
if [ -z "$CURRENT_IP" ]; then
    echo "‚ùå –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ –º–æ–¥–µ–º"
    echo "üîß –ü–æ–¥–æ–∂–¥–∏ –µ—â–µ –Ω–µ–º–Ω–æ–≥–æ –ø–æ–∫–∞ –º–æ–¥–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è"
    exit 1
fi

echo "‚úÖ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç–µ–∫—É—â–∏–π IP: $CURRENT_IP"

echo ""
echo "3. –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è IP —á–µ—Ä–µ–∑ HiLink API"
echo "========================================"

# –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω —Å–µ—Å—Å–∏–∏
echo "üîë –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ —Å–µ—Å—Å–∏–∏..."
SESSION_TOKEN=$(get_session_token)

if [ -z "$SESSION_TOKEN" ]; then
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω —Å–µ—Å—Å–∏–∏"
    echo "üîß –í–æ–∑–º–æ–∂–Ω–æ, –º–æ–¥–µ–º –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç API –∏–ª–∏ —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é"
    exit 1
fi

IFS='|' read -r SESSION_ID TOKEN <<< "$SESSION_TOKEN"
echo "‚úÖ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω"

# –ú–µ—Ç–æ–¥ 1: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ/–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ dial API
echo ""
echo "üîÑ –ú–µ—Ç–æ–¥ 1: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ/–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"
echo "=============================================="

echo "üì§ –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è..."
disconnect_response=$(curl -s -m 10 -X POST \
    -H "Content-Type: application/x-www-form-urlencoded; charset=UTF-8" \
    -H "Cookie: SessionID=$SESSION_ID" \
    -H "__RequestVerificationToken: $TOKEN" \
    -d '<?xml version="1.0" encoding="UTF-8"?><request><Action>0</Action></request>' \
    "http://$MODEM_IP/api/dialup/dial" 2>/dev/null)

echo "üìã –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–∫–ª—é—á–µ–Ω–∏—è:"
echo "$disconnect_response"

echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ 10 —Å–µ–∫—É–Ω–¥..."
sleep 10

echo "üì§ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è..."
connect_response=$(curl -s -m 10 -X POST \
    -H "Content-Type: application/x-www-form-urlencoded; charset=UTF-8" \
    -H "Cookie: SessionID=$SESSION_ID" \
    -H "__RequestVerificationToken: $TOKEN" \
    -d '<?xml version="1.0" encoding="UTF-8"?><request><Action>1</Action></request>' \
    "http://$MODEM_IP/api/dialup/dial" 2>/dev/null)

echo "üìã –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
echo "$connect_response"

echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (20 —Å–µ–∫—É–Ω–¥)..."
sleep 20

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–π IP
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤–æ–≥–æ IP..."
NEW_IP_1=$(get_external_ip)
echo "üìã IP –ø–æ—Å–ª–µ –º–µ—Ç–æ–¥–∞ 1: $NEW_IP_1"

if [ "$NEW_IP_1" != "$CURRENT_IP" ] && [ -n "$NEW_IP_1" ]; then
    echo "üéâ –£–°–ü–ï–•! IP –∏–∑–º–µ–Ω–∏–ª—Å—è: $CURRENT_IP ‚Üí $NEW_IP_1"
    echo "‚úÖ –ú–µ—Ç–æ–¥ HiLink API —Ä–∞–±–æ—Ç–∞–µ—Ç!"

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞–±–æ—á–∏–π –º–µ—Ç–æ–¥
    echo ""
    echo "üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—á–µ–≥–æ –º–µ—Ç–æ–¥–∞..."
    cat > hilink_rotation_method.txt << EOF
–†–ê–ë–û–ß–ò–ô –ú–ï–¢–û–î –†–û–¢–ê–¶–ò–ò IP:
========================
–ú–µ—Ç–æ–¥: HiLink API dial
URL: http://$MODEM_IP/api/dialup/dial
–û—Ç–∫–ª—é—á–µ–Ω–∏–µ: Action=0
–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: Action=1
–¢–æ–∫–µ–Ω: –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ª—É—á–∞—Ç—å –∫–∞–∂–¥—ã–π —Ä–∞–∑
–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è: 10 —Å–µ–∫ –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ + 20 —Å–µ–∫ –Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
–†–µ–∑—É–ª—å—Ç–∞—Ç: IP –∏–∑–º–µ–Ω–∏–ª—Å—è —Å $CURRENT_IP –Ω–∞ $NEW_IP_1

–ö–û–ú–ê–ù–î–´ –î–õ–Ø PYTHON:
==================
1. GET /api/webserver/SesTokInfo ‚Üí –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω
2. POST /api/dialup/dial + Action=0 ‚Üí –æ—Ç–∫–ª—é—á–∏—Ç—å
3. sleep(10)
4. POST /api/dialup/dial + Action=1 ‚Üí –ø–æ–¥–∫–ª—é—á–∏—Ç—å
5. sleep(20)
6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—ã–π IP
EOF

    echo "‚úÖ –ú–µ—Ç–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ hilink_rotation_method.txt"

else
    echo "‚ö†Ô∏è IP –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è –∏–ª–∏ –Ω–µ –ø–æ–ª—É—á–µ–Ω"
    echo "üîß –ü–æ–ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥..."

    # –ú–µ—Ç–æ–¥ 2: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–º–∞ —á–µ—Ä–µ–∑ API
    echo ""
    echo "üîÑ –ú–µ—Ç–æ–¥ 2: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–º–∞ —á–µ—Ä–µ–∑ API"
    echo "========================================"

    echo "üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏..."
    reboot_response=$(curl -s -m 10 -X POST \
        -H "Content-Type: application/x-www-form-urlencoded; charset=UTF-8" \
        -H "Cookie: SessionID=$SESSION_ID" \
        -H "__RequestVerificationToken: $TOKEN" \
        -d '<?xml version="1.0" encoding="UTF-8"?><request><Control>1</Control></request>' \
        "http://$MODEM_IP/api/device/control" 2>/dev/null)

    echo "üìã –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏:"
    echo "$reboot_response"

    echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–º–∞ (45 —Å–µ–∫—É–Ω–¥)..."
    sleep 45

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º IP –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ IP –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏..."
    NEW_IP_2=$(get_external_ip)
    echo "üìã IP –ø–æ—Å–ª–µ –º–µ—Ç–æ–¥–∞ 2: $NEW_IP_2"

    if [ "$NEW_IP_2" != "$CURRENT_IP" ] && [ -n "$NEW_IP_2" ]; then
        echo "üéâ –£–°–ü–ï–•! IP –∏–∑–º–µ–Ω–∏–ª—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏: $CURRENT_IP ‚Üí $NEW_IP_2"
        echo "‚úÖ –ú–µ—Ç–æ–¥ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç!"
    else
        echo "‚ö†Ô∏è IP –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è –¥–∞–∂–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏"
        echo "üîß –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
        echo "   - –û–ø–µ—Ä–∞—Ç–æ—Ä –Ω–µ –º–µ–Ω—è–µ—Ç IP –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏"
        echo "   - –ú–æ–¥–µ–º –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ—Ç –∂–µ IP –æ—Ç DHCP —Å–µ—Ä–≤–µ—Ä–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞"
        echo "   - –ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏"
    fi
fi

echo ""
echo "üìä –§–ò–ù–ê–õ–¨–ù–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢:"
echo "======================"
echo "–ò—Å—Ö–æ–¥–Ω—ã–π IP:           $CURRENT_IP"
echo "–ü–æ—Å–ª–µ HiLink API:      $NEW_IP_1"
echo "–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏:    $NEW_IP_2"

echo ""
echo "üîê –í–ê–ñ–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò:"
echo "==============================="
echo "‚úÖ –ò–°–ü–û–õ–¨–ó–£–ô –¢–û–õ–¨–ö–û:"
echo "   - HiLink –≤–µ–±-API"
echo "   - –ö–æ–º–∞–Ω–¥—ã —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"
echo "   - –§–∏–∑–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ"
echo ""
echo "‚ùå –ù–ò–ö–û–ì–î–ê –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô:"
echo "   - AT –∫–æ–º–∞–Ω–¥—ã (AT+CFUN, AT+CGACT, etc.)"
echo "   - –ü—Ä—è–º—ã–µ –∫–æ–º–∞–Ω–¥—ã –≤ —Ç–µ–ª–Ω–µ—Ç/ADB"
echo "   - –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã —Å —Å–µ—Ç–µ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏"
echo ""
echo "üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø:"
echo "–ï—Å–ª–∏ HiLink API –Ω–µ –º–µ–Ω—è–µ—Ç IP, —Ç–æ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ"
echo "—Ç–≤–æ–π –æ–ø–µ—Ä–∞—Ç–æ—Ä –Ω–µ –≤—ã–¥–∞–µ—Ç –Ω–æ–≤—ã–π IP –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏."
echo "–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –º–Ω–æ–≥–∏—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤."
