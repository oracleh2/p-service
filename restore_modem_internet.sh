#!/bin/bash

# –≠–ö–°–¢–†–ï–ù–ù–û–ï –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–ù–ï–¢–ê –ù–ê –ú–û–î–ï–ú–ï
MODEM_IP="192.168.108.1"
INTERFACE="enx0c5b8f279a64"

echo "üö® –≠–ö–°–¢–†–ï–ù–ù–û–ï –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–ù–ï–¢–ê –ù–ê –ú–û–î–ï–ú–ï"
echo "================================================"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ —á–µ—Ä–µ–∑ telnet
execute_telnet_command() {
    local command="$1"
    local wait_time=${2:-5}

    echo "üîß –í—ã–ø–æ–ª–Ω—è—é: $command"
    {
        sleep 1
        echo "$command"
        sleep $wait_time
        echo "exit"
    } | timeout 20 telnet "$MODEM_IP" 2>/dev/null | grep -v "Trying\|Connected\|Escape\|Connection closed"
}

echo ""
echo "1. –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –†–ê–î–ò–û –ú–û–î–£–õ–Ø"
echo "=============================="

echo "üîÑ –í–∫–ª—é—á–∞–µ–º —Ä–∞–¥–∏–æ –º–æ–¥—É–ª—å..."
execute_telnet_command "atc AT+CFUN=1" 10

echo ""
echo "2. –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –í –°–ï–¢–ò"
echo "===================================="

echo "üîç –ü–æ–∏—Å–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ—Ç–µ–π..."
execute_telnet_command "atc AT+COPS=0" 15

echo ""
echo "3. –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï PDP –ö–û–ù–¢–ï–ö–°–¢–ê"
echo "==============================="

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ APN..."
execute_telnet_command "atc AT+CGDCONT=1,\"IP\",\"internet\"" 5

echo "üîÑ –ê–∫—Ç–∏–≤–∞—Ü–∏—è PDP –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞..."
execute_telnet_command "atc AT+CGACT=1,1" 10

echo ""
echo "4. –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê –°–ï–¢–ò"
echo "======================="

echo "üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ —Å–µ—Ç–∏..."
execute_telnet_command "atc AT+CREG?" 3

echo "üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Å–µ—Ç–∏..."
execute_telnet_command "atc AT+COPS?" 3

echo "üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ PDP –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞..."
execute_telnet_command "atc AT+CGACT?" 3

echo ""
echo "5. –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –°–ï–¢–ï–í–´–• –ò–ù–¢–ï–†–§–ï–ô–°–û–í"
echo "====================================="

echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ wan0..."
execute_telnet_command "ifconfig wan0" 3

echo "üîß –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ wan0..."
execute_telnet_command "ifconfig wan0 down" 3
execute_telnet_command "ifconfig wan0 up" 5

echo ""
echo "6. –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ú–ê–†–®–†–£–¢–ò–ó–ê–¶–ò–ò"
echo "=============================="

echo "üõ£Ô∏è –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤..."
# –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –∫ —à–ª—é–∑—É
execute_telnet_command "route add default gw 10.64.64.1 wan0" 3

echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤..."
execute_telnet_command "route -n" 3

echo ""
echo "7. –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ü–û–ü–´–¢–ö–ò –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø"
echo "========================================"

echo "üîÑ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è..."
execute_telnet_command "atc AT+CGACT=0" 5
execute_telnet_command "atc AT+CGACT=1" 10

echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ DHCP –∫–ª–∏–µ–Ω—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)..."
execute_telnet_command "killall dhcpc" 3
execute_telnet_command "dhcpc -i wan0" 5

echo ""
echo "8. –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê"
echo "===================="

echo "üìã –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤..."
execute_telnet_command "ifconfig" 3

echo "üìã –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤..."
execute_telnet_command "route -n" 3

echo "üìã –ü–∏–Ω–≥ Google DNS..."
execute_telnet_command "ping -c 3 8.8.8.8" 10

echo ""
echo "9. –ü–†–û–í–ï–†–ö–ê –ò–ù–¢–ï–†–ù–ï–¢–ê –ù–ê –°–ò–°–¢–ï–ú–ï"
echo "==============================="

echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
echo "üîç –¢–µ—Å—Ç 1: –ü–∏–Ω–≥ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å..."
if timeout 5 ping -I "$INTERFACE" -c 1 8.8.8.8 >/dev/null 2>&1; then
    echo "‚úÖ Ping —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "‚ùå Ping –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
fi

echo "üîç –¢–µ—Å—Ç 2: HTTP –∑–∞–ø—Ä–æ—Å..."
EXTERNAL_IP=$(timeout 10 curl --interface "$INTERFACE" -s https://httpbin.org/ip 2>/dev/null | grep -o '"[0-9.]*"' | tr -d '"')
if [ -n "$EXTERNAL_IP" ]; then
    echo "‚úÖ HTTP —Ä–∞–±–æ—Ç–∞–µ—Ç. –í–Ω–µ—à–Ω–∏–π IP: $EXTERNAL_IP"
else
    echo "‚ùå HTTP –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
fi

echo ""
echo "10. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Æ"
echo "=================================="

if [ -n "$EXTERNAL_IP" ]; then
    echo "üéâ –£–°–ü–ï–•! –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    echo "üìã –í–Ω–µ—à–Ω–∏–π IP: $EXTERNAL_IP"
    echo "‚úÖ –ú–æ–¥–µ–º —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ"
else
    echo "‚ö†Ô∏è –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –ø–æ–∫–∞ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    echo ""
    echo "üîß –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —ç—Ç–∏ –¥–µ–π—Å—Ç–≤–∏—è:"
    echo "1. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –º–æ–¥–µ–º:"
    echo "   sudo usb_modeswitch -R -v 12d1 -p 1f01"
    echo ""
    echo "2. –ò–ª–∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª—é—á–∏—Ç–µ/–ø–æ–¥–∫–ª—é—á–∏—Ç–µ –º–æ–¥–µ–º"
    echo ""
    echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SIM –∫–∞—Ä—Ç—É –∏ PIN –∫–æ–¥"
    echo ""
    echo "4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ HiLink –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:"
    echo "   curl -X POST http://192.168.108.1/api/device/control -d '<?xml version=\"1.0\"?><request><Control>1</Control></request>'"
fi

echo ""
echo "11. –ó–ê–©–ò–¢–ê –û–¢ –ü–û–í–¢–û–†–ù–´–• –ü–†–û–ë–õ–ï–ú"
echo "==============================="

echo "‚ö†Ô∏è –í–ê–ñ–ù–û: AT+CFUN –∫–æ–º–∞–Ω–¥—ã –º–æ–≥—É—Ç —Å–±–∏–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ç–∏"
echo "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –º–µ—Ç–æ–¥—ã:"
echo "   - HiLink API –¥–ª—è —Ä–æ—Ç–∞—Ü–∏–∏ IP"
echo "   - ADB –∫–æ–º–∞–Ω–¥—ã (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã)"
echo "   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"
echo ""
echo "‚ùå –ò–ó–ë–ï–ì–ê–ô–¢–ï:"
echo "   - AT+CFUN=0/1 (—Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–µ—Ç—å)"
echo "   - AT+CGACT –±–µ–∑ –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π"
echo "   - –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ —Å AT –∫–æ–º–∞–Ω–¥–∞–º–∏ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ"
