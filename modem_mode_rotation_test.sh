#!/bin/bash

# –¢–µ—Å—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤ –º–æ–¥–µ–º–∞ –¥–ª—è —Ä–æ—Ç–∞—Ü–∏–∏ IP
INTERFACE="enx0c5b8f279a64"
MODEM_IP="192.168.108.1"
DEVICE_ID="12d1:14dc"  # Huawei E3372 HiLink

echo "üîÑ –¢–µ—Å—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤ –º–æ–¥–µ–º–∞ –¥–ª—è —Ä–æ—Ç–∞—Ü–∏–∏ IP"
echo "=================================================="

# –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ IP
get_external_ip() {
    local ip=$(timeout 10 curl --interface "$INTERFACE" -s https://httpbin.org/ip 2>/dev/null | grep -o '"[0-9.]*"' | tr -d '"' || echo "unknown")
    echo "$ip"
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
check_interface() {
    if ip link show "$INTERFACE" >/dev/null 2>&1; then
        if ip addr show "$INTERFACE" | grep -q "inet "; then
            return 0
        fi
    fi
    return 1
}

# –§—É–Ω–∫—Ü–∏—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
wait_for_interface() {
    local timeout=60
    local counter=0

    echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ—è–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ $INTERFACE..."

    while [ $counter -lt $timeout ]; do
        if check_interface; then
            echo "‚úÖ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å $INTERFACE –¥–æ—Å—Ç—É–ø–µ–Ω"
            return 0
        fi

        echo "  –ü—Ä–æ–≤–µ—Ä–∫–∞ ($((counter+1))/$timeout)..."
        sleep 1
        counter=$((counter + 1))
    done

    echo "‚ùå –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –ø–æ—è–≤–∏–ª—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ $timeout —Å–µ–∫—É–Ω–¥"
    return 1
}

# –§—É–Ω–∫—Ü–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
activate_interface() {
    echo "üîß –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ $INTERFACE..."

    # –ü–æ–¥–Ω–∏–º–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    sudo ip link set "$INTERFACE" up 2>/dev/null || true
    sleep 2

    # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    sudo ip addr flush dev "$INTERFACE" 2>/dev/null || true
    sudo pkill -f "dhclient.*$INTERFACE" 2>/dev/null || true

    # –ü–æ–ª—É—á–∞–µ–º IP —á–µ—Ä–µ–∑ DHCP
    echo "  üì° –ü–æ–ª—É—á–µ–Ω–∏–µ IP —á–µ—Ä–µ–∑ DHCP..."
    timeout 20 sudo dhclient "$INTERFACE" 2>/dev/null || true

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if check_interface; then
        local ip=$(ip addr show "$INTERFACE" | grep "inet " | awk '{print $2}' | head -1)
        echo "  ‚úÖ IP –ø–æ–ª—É—á–µ–Ω: $ip"
        return 0
    else
        echo "  ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å IP"
        return 1
    fi
}

# –ü–æ–ª—É—á–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π IP
echo ""
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è"
echo "================================"

if check_interface; then
    INITIAL_IP=$(get_external_ip)
    echo "‚úÖ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–∫—Ç–∏–≤–µ–Ω"
    echo "üåê –ù–∞—á–∞–ª—å–Ω—ã–π –≤–Ω–µ—à–Ω–∏–π IP: $INITIAL_IP"
else
    echo "‚ùå –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω"
    echo "üîß –ü–æ–ø—ã—Ç–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏..."
    if activate_interface; then
        INITIAL_IP=$(get_external_ip)
        echo "üåê –ù–∞—á–∞–ª—å–Ω—ã–π –≤–Ω–µ—à–Ω–∏–π IP: $INITIAL_IP"
    else
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"
        exit 1
    fi
fi

echo ""
echo "üîÑ –ú–µ—Ç–æ–¥ 1: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ Storage Mode –∏ –æ–±—Ä–∞—Ç–Ω–æ"
echo "================================================"

# –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ USB —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
vendor=$(echo "$DEVICE_ID" | cut -d: -f1)
product=$(echo "$DEVICE_ID" | cut -d: -f2)

echo "üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: $vendor:$product"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞..."
current_mode=$(lsusb -v -d "$DEVICE_ID" 2>/dev/null | grep -E "bInterfaceClass.*[0-9]" | head -1)
echo "  –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: $current_mode"

# –®–∞–≥ 1: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ Storage Mode
echo ""
echo "üîÑ –®–∞–≥ 1: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ Storage Mode"
echo "===================================="

echo "üîß –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤ Storage Mode..."

# –ú–µ—Ç–æ–¥ 1: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤ storage
if [ -f "/usr/share/usb_modeswitch/$DEVICE_ID" ]; then
    echo "  –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ /usr/share/usb_modeswitch/$DEVICE_ID"
    sudo usb_modeswitch -v "$vendor" -p "$product" -c "/usr/share/usb_modeswitch/$DEVICE_ID" -R 2>/dev/null
else
    echo "  –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∫–æ–º–∞–Ω–¥—É –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤ storage"
    # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤ storage mode
    sudo usb_modeswitch -v "$vendor" -p "$product" -M '55534243123456780000000000000a11062000000000000100000000000000' -R 2>/dev/null
fi

echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤ storage mode (15 —Å–µ–∫—É–Ω–¥)..."
sleep 15

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ storage mode
storage_check=$(lsusb -v -d "$DEVICE_ID" 2>/dev/null | grep "bInterfaceClass.*8 Mass Storage" || echo "")
if [ -n "$storage_check" ]; then
    echo "‚úÖ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–æ—Å—å –≤ Storage Mode"
else
    echo "‚ö†Ô∏è –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å –≤ Storage Mode (–∏–ª–∏ —É–∂–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è)"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏—Å—á–µ–∑
if ! check_interface; then
    echo "‚úÖ –°–µ—Ç–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏—Å—á–µ–∑ (–º–æ–¥–µ–º –≤ Storage Mode)"
else
    echo "‚ö†Ô∏è –°–µ—Ç–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤—Å—ë –µ—â—ë –¥–æ—Å—Ç—É–ø–µ–Ω"
fi

echo ""
echo "üîÑ –®–∞–≥ 2: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ HiLink Mode"
echo "=========================================="

echo "üîß –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ –≤ HiLink Mode..."

# –†–∞–∑–ª–∏—á–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ –≤ HiLink
echo "  –°–ø–æ—Å–æ–± 1: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ"
sudo usb_modeswitch -v "$vendor" -p "$product" -J 2>/dev/null || true
sleep 5

echo "  –°–ø–æ—Å–æ–± 2: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞"
sudo usb_modeswitch -v "$vendor" -p "$product" -H 2>/dev/null || true
sleep 5

echo "  –°–ø–æ—Å–æ–± 3: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –±–µ–∑ -R —Ñ–ª–∞–≥–∞"
sudo usb_modeswitch -v "$vendor" -p "$product" 2>/dev/null || true
sleep 5

echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ –≤ HiLink mode (20 —Å–µ–∫—É–Ω–¥)..."
sleep 20

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–æ—Å—å –æ–±—Ä–∞—Ç–Ω–æ
hilink_check=$(lsusb -v -d "$DEVICE_ID" 2>/dev/null | grep "bInterfaceClass.*2 Communications" || echo "")
if [ -n "$hilink_check" ]; then
    echo "‚úÖ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–æ—Å—å –æ–±—Ä–∞—Ç–Ω–æ –≤ HiLink Mode"
else
    echo "‚ö†Ô∏è –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å –≤ HiLink Mode"
fi

# –û–∂–∏–¥–∞–µ–º –ø–æ—è–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
if wait_for_interface; then
    if activate_interface; then
        echo "‚úÖ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è"
    else
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è"
    fi
else
    echo "‚ùå –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –ø–æ—è–≤–∏–ª—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è"
fi

echo ""
echo "üîÑ –ú–µ—Ç–æ–¥ 2: –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ USB"
echo "========================================="

echo "üîß –ü–æ–∏—Å–∫ USB —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ —Å–∏—Å—Ç–µ–º–µ..."
USB_DEVICE_PATH=$(find /sys/bus/usb/devices -name "*$vendor*" -type d | head -1)

if [ -n "$USB_DEVICE_PATH" ]; then
    echo "üì± USB —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–æ: $USB_DEVICE_PATH"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º authorized —Ñ–∞–π–ª
    if [ -f "$USB_DEVICE_PATH/authorized" ] && [ -w "$USB_DEVICE_PATH/authorized" ]; then
        echo "üîß –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ USB..."
        echo 0 | sudo tee "$USB_DEVICE_PATH/authorized" >/dev/null
        sleep 5

        echo "üîß –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ USB..."
        echo 1 | sudo tee "$USB_DEVICE_PATH/authorized" >/dev/null
        sleep 10

        echo "‚úÖ USB –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ"
    else
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–ø—Ä–∞–≤–ª—è—Ç—å USB authorized"
    fi
else
    echo "‚ùå USB —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ sysfs"
fi

echo ""
echo "üîÑ –ú–µ—Ç–æ–¥ 3: –°–±—Ä–æ—Å —á–µ—Ä–µ–∑ reset endpoint"
echo "===================================="

echo "üîß –ü–æ–ø—ã—Ç–∫–∞ —Å–±—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ usb_modeswitch reset..."
sudo usb_modeswitch -v "$vendor" -p "$product" -R 2>/dev/null || true
sleep 15

if wait_for_interface; then
    if activate_interface; then
        echo "‚úÖ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ—Å–ª–µ reset"
    fi
fi

echo ""
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–æ—Ç–∞—Ü–∏–∏"
echo "==============================="

if check_interface; then
    echo "‚úÖ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å $INTERFACE –∞–∫—Ç–∏–≤–µ–Ω"

    # –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–π IP
    echo "üåê –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≤–Ω–µ—à–Ω–µ–≥–æ IP..."
    NEW_IP=$(get_external_ip)

    echo ""
    echo "üìã –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–æ—Ç–∞—Ü–∏–∏:"
    echo "  –ù–∞—á–∞–ª—å–Ω—ã–π IP: $INITIAL_IP"
    echo "  –ù–æ–≤—ã–π IP:     $NEW_IP"

    if [ "$INITIAL_IP" != "$NEW_IP" ] && [ "$NEW_IP" != "unknown" ] && [ -n "$NEW_IP" ]; then
        echo "  ‚úÖ IP —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–∏–ª—Å—è!"
        echo ""
        echo "üéâ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤ –º–æ–¥–µ–º–∞ –†–ê–ë–û–¢–ê–ï–¢ –¥–ª—è —Ä–æ—Ç–∞—Ü–∏–∏ IP!"
    else
        echo "  ‚ö†Ô∏è IP –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è –∏–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π IP"
        echo ""
        echo "‚ùå –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤ –º–æ–¥–µ–º–∞ –ù–ï –†–ê–ë–û–¢–ê–ï–¢ –¥–ª—è —Ä–æ—Ç–∞—Ü–∏–∏ IP"
    fi

    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    echo ""
    echo "üìä –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
    local_ip=$(ip addr show "$INTERFACE" | grep "inet " | awk '{print $2}' | head -1)
    gateway=$(ip route show dev "$INTERFACE" | grep default | awk '{print $3}' | head -1)
    echo "  –õ–æ–∫–∞–ª—å–Ω—ã–π IP: $local_ip"
    echo "  –®–ª—é–∑:        $gateway"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –º–æ–¥–µ–º–∞
    if ping -c 1 -W 2 "$MODEM_IP" >/dev/null 2>&1; then
        echo "  –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: $MODEM_IP –¥–æ—Å—Ç—É–ø–µ–Ω"
    else
        echo "  –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: $MODEM_IP –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    fi

else
    echo "‚ùå –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å $INTERFACE –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω"
    echo "‚ùå –¢–µ—Å—Ç –Ω–µ —É–¥–∞–ª—Å—è - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
fi

echo ""
echo "üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞"
echo "======================="

echo "üì± –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± USB —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ:"
lsusb | grep "$DEVICE_ID" || echo "  –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"

echo ""
echo "üîß –†–µ–∂–∏–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:"
device_mode=$(lsusb -v -d "$DEVICE_ID" 2>/dev/null | grep -E "bInterfaceClass.*[0-9]" | head -1)
echo "  $device_mode"

echo ""
echo "üåê –°–µ—Ç–µ–≤—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã:"
ip link show | grep -E "enx" || echo "  USB –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

echo ""
echo "üìä –°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫):"
sudo dmesg | tail -10 | grep -i "usb\|cdc\|rndis\|hilink" || echo "  –ù–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –ª–æ–≥–æ–≤"

echo ""
echo "üèÅ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω"
echo "==============="

if [ "$INITIAL_IP" != "$NEW_IP" ] && [ "$NEW_IP" != "unknown" ] && [ -n "$NEW_IP" ]; then
    echo "‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤ –º–æ–¥–µ–º–∞ –≠–§–§–ï–ö–¢–ò–í–ù–û –¥–ª—è —Ä–æ—Ç–∞—Ü–∏–∏ IP!"
    echo ""
    echo "üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:"
    echo "1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥ 'mode_switch' –≤ RotationManager"
    echo "2. –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ (15-20 —Å–µ–∫—É–Ω–¥)"
    echo "3. –û–±–µ—Å–ø–µ—á–∏—Ç—å –ø–µ—Ä–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—é –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è"
    echo "4. –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—è–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"
    echo "5. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å retry –ª–æ–≥–∏–∫—É –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏"
else
    echo "‚ùå –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤ –º–æ–¥–µ–º–∞ –ù–ï –≠–§–§–ï–ö–¢–ò–í–ù–û –¥–ª—è —Ä–æ—Ç–∞—Ü–∏–∏ IP"
    echo ""
    echo "üîß –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:"
    echo "1. –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å API –º–æ–¥–µ–º–∞ –¥–ª—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"
    echo "2. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ USB"
    echo "3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å AT-–∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"
    echo "4. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã —Ä–æ—Ç–∞—Ü–∏–∏ IP"
fi
